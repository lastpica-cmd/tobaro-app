<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <title>TOBARO - í† ì„ ë§¤ì¹­ ì±—ë´‡</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=cc393f84546f58b913c7314ad5a9e445&autoload=false&libraries=services"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>console.log('TOBARO build = 2025-10-08-01');</script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .main-container {
            display: flex;
            gap: 20px;
            height: 90vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .chat-section {
            flex: 1.2;
            min-width: 500px;
        }
        
        .map-section {
            flex: 0.95;
            min-width: 400px;
        }
        
        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .map-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            height: 100%;
            position: relative;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .chat-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .chat-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            display: flex;
            gap: 10px;
            max-width: 80%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.bot {
            align-self: flex-start;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #667eea;
            color: white;
        }
        
        .message.bot .message-avatar {
            background: #e9ecef;
            color: #495057;
        }
        
        .message-content {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .message.user .message-content {
            background: #667eea;
            color: white;
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .chat-input input:focus {
            border-color: #667eea;
        }
        
        .chat-input button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chat-input button:hover {
            background: #5a6fd8;
            transform: scale(1.05);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .example-queries {
            margin-top: 15px;
        }
        
        .example-query {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .example-query:hover {
            background: #667eea;
            color: white;
        }
        
        .result-table {
            margin-top: 10px;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .result-table table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        
        .result-table th,
        .result-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .result-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        /* ë‹¨ìœ„ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .result-table th small {
            font-size: 0.8em;
            color: #666;
            font-weight: 400;
        }
        
        /* ìˆœìœ„ ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì • ë° ê°€ìš´ë° ì •ë ¬ */
        .result-table th:nth-child(1),
        .result-table td:nth-child(1) {
            width: auto;
            min-width: 80px;
            max-width: 100px;
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        .result-table td:nth-child(1) .badge {
            display: block !important;
            margin: 0 auto !important;
            text-align: center !important;
            width: fit-content !important;
        }
        
        /* ë” êµ¬ì²´ì ì¸ ì„ íƒìë¡œ ìš°ì„ ìˆœìœ„ ê°•í™” */
        .result-table tbody tr td:nth-child(1) .badge {
            display: block !important;
            margin: 0 auto !important;
            text-align: center !important;
            width: fit-content !important;
        }
        
        /* ìˆœìœ„ ë°°ì§€ ì „ìš© ìŠ¤íƒ€ì¼ - ìµœê³  ìš°ì„ ìˆœìœ„ */
        .rank-badge {
            display: block !important;
            margin: 0 auto !important;
            text-align: center !important;
            width: fit-content !important;
        }
        
        /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ê³¼ í•¨ê»˜ ì‘ë™í•˜ë„ë¡ ì¶”ê°€ ë³´ì¥ */
        .result-table td:nth-child(1) span.badge.rank-badge {
            display: block !important;
            margin: 0 auto !important;
            text-align: center !important;
            width: fit-content !important;
        }
        
        /* ê³µê¸‰ì²˜ ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì • ë° ë§ì¤„ì„ íš¨ê³¼ */
        .result-table th:nth-child(2),
        .result-table td:nth-child(2) {
            width: 25%;
            min-width: 150px;
        }
        
        .col-supplier {
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ë‹¤ë¥¸ ì»¬ëŸ¼ë“¤ ë„ˆë¹„ ì¡°ì • (ì ìˆ˜ ì»¬ëŸ¼ ì œê±° í›„) */
        .result-table th:nth-child(3),
        .result-table td:nth-child(3) { width: 12%; }  /* ê±°ë¦¬ */
        .result-table th:nth-child(4),
        .result-table td:nth-child(4) { width: 16%; } /* ê°€ìš© ê³µê¸‰ëŸ‰ */
        .result-table th:nth-child(5),
        .result-table td:nth-child(5) { width: 14%; } /* í† ì„ìœ í˜• */
        .result-table th:nth-child(6),
        .result-table td:nth-child(6) { width: 16%; } /* ì í•©ìš©ë„ */
        .result-table th:nth-child(7),
        .result-table td:nth-child(7) { width: 16%; } /* ìš´ì†¡ë¹„ */
        
        .map-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .map-header h1 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .map-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.85rem;
        }
        
        .map-content {
            height: calc(100% - 80px);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 0 0 20px 20px;
        }
        
        .map-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            z-index: 1000;
        }
        
        .landuse-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
            color: white;
        }
        
        .landuse-toggle-btn:hover {
            background: rgba(76, 175, 80, 1);
            transform: scale(1.1);
        }
        
        .landuse-toggle-btn.active {
            background: rgba(255, 152, 0, 0.9);
        }
        
        .landuse-toggle-btn.active:hover {
            background: rgba(255, 152, 0, 1);
        }
        
        .route-toggle-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            background: rgba(0, 123, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
            color: white;
        }
        
        .route-toggle-btn:hover {
            background: rgba(0, 123, 255, 1);
            transform: scale(1.1);
        }
        
        .route-toggle-btn.active {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .route-toggle-btn.active:hover {
            background: rgba(220, 53, 69, 1);
        }
        
        /* í† ì§€ ì´ìš© í˜„í™© ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
        .landuse-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
        }
        
        .landuse-chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
        }
        
        .landuse-chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .landuse-chart-wrapper {
            position: relative;
            height: 150px; /* 200pxì—ì„œ 150pxë¡œ ì¶•ì†Œ */
            margin-bottom: 8px; /* 10pxì—ì„œ 8pxë¡œ ì¶•ì†Œ */
        }
        
        .landuse-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px; /* 8pxì—ì„œ 4pxë¡œ ì¶•ì†Œ */
            font-size: 0.7rem; /* 0.8remì—ì„œ 0.7remìœ¼ë¡œ ì¶•ì†Œ */
            margin-top: 8px; /* 10pxì—ì„œ 8pxë¡œ ì¶•ì†Œ */
        }
        
        .landuse-legend-item {
            display: flex;
            align-items: center;
            gap: 3px; /* 4pxì—ì„œ 3pxë¡œ ì¶•ì†Œ */
            color: #333;
            font-weight: 500;
        }
        
        .landuse-legend-color {
            width: 10px; /* 12pxì—ì„œ 10pxë¡œ ì¶•ì†Œ */
            height: 10px; /* 12pxì—ì„œ 10pxë¡œ ì¶•ì†Œ */
            border-radius: 2px;
            flex-shrink: 0;
        }
        
        .landuse-legend-item span {
            color: #333;
            font-size: 0.65rem; /* 0.75remì—ì„œ 0.65remìœ¼ë¡œ ì¶•ì†Œ */
            white-space: nowrap;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .bg-primary {
            background-color: #007bff !important;
            color: white;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-section,
            .map-section {
                min-width: auto;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ì±„íŒ… ì„¹ì…˜ -->
        <div class="chat-section">
            <div class="chat-container">
                <div class="chat-header">
                    <h1><i class="fas fa-robot"></i> TOBARO</h1>
                    <p>í† ì„ì •ë³´ê³µìœ ì‹œìŠ¤í…œ ì±—ë´‡ - ìì—°ì–´ë¡œ í† ì‚¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            ì•ˆë…•í•˜ì„¸ìš”! TOBARO í† ì„ ë§¤ì¹­ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ”ï¸<br>
                            ìì—°ì–´ë¡œ í† ì‚¬ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”!<br><br>
                            <strong>ì˜ˆì‹œ ì§ˆë¬¸:</strong><br>
                            <div class="example-queries">
                                <span class="example-query" onclick="sendExampleQuery('ì˜ˆì‚°êµ°ì—ì„œ ì œë°© ë³µêµ¬ìš© í† ì„ì„ ì–´ë””ì„œ êµ¬í•  ìˆ˜ ìˆì–´?')">ì˜ˆì‚°êµ°ì—ì„œ ì œë°© ë³µêµ¬ìš© í† ì„ì„ ì–´ë””ì„œ êµ¬í•  ìˆ˜ ìˆì–´?</span>
                                <span class="example-query" onclick="sendExampleQuery('ì˜ˆì²œêµ°ì—ì„œ ë†ì‚¬ìš© í™ 500mÂ³ í•„ìš”í•´')">ì˜ˆì²œêµ°ì—ì„œ ë†ì‚¬ìš© í™ 500mÂ³ í•„ìš”í•´</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <i class="fas fa-spinner"></i> ë¶„ì„ ì¤‘...
                </div>
                
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="í† ì‚¬ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                    <button id="sendButton" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                </div>
            </div>
        </div>
        
        <!-- ì§€ë„ ì„¹ì…˜ -->
        <div class="map-section">
            <div class="map-container">
                <!-- ì§€ë„ í—¤ë” -->
                <div class="map-header">
                    <h1><i class="fas fa-map-marked-alt"></i> í† ì„ì •ë³´ ë§¤ì¹­ ì œì•ˆ</h1>
                    <p>ë§¤ì¹­ëœ í† ì‚¬ ê³µê¸‰ì²˜ë¥¼ ì§€ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”!</p>
                </div>
                
                <!-- ì§€ë„ ì˜ì—­ -->
                <div class="map-content">
                    <div id="map"></div>
                    <div class="map-info" id="mapInfo">
                        í† ì‚¬ ë§¤ì¹­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                    
                    <!-- ê²½ë¡œ í‘œì‹œ ë²„íŠ¼ -->
                    <button class="route-toggle-btn" id="routeToggleBtn" onclick="toggleRoutes()" title="ê²½ë¡œ í‘œì‹œ/ìˆ¨ê¹€">
                        <i class="fas fa-route"></i>
                    </button>
                    
                    <!-- í† ì§€ ì´ìš© í˜„í™© ë²„íŠ¼ -->
                    <button class="landuse-toggle-btn" id="landuseToggleBtn" onclick="toggleLanduse()" title="í† ì§€ ì´ìš© í˜„í™© ë³´ê¸°">
                        <i class="fas fa-seedling"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let markers = [];
        let routePolylines = [];
        let userLocation = null;
        let currentMatchingResult = null;
        let totalDuration = 0; // ì´ ì†Œìš”ì‹œê°„ (ì´ˆ)
        let routeCount = 0; // ì™„ë£Œëœ ê²½ë¡œ ìˆ˜
        let currentRegion = null;
        let isRouteMode = false;
        let isLanduseMode = false;
        
        // ê²½ë¡œ API ê²°ê³¼ ìºì‹±
        const routeCache = new Map();

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì‹œì²­
                level: 8
            };
            
            map = new kakao.maps.Map(container, options);
            console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // í† ì‚¬ ë§ˆì»¤ ì¶”ê°€
        function addSoilMarkers(soilData) {
            clearMarkers();
            
            if (!soilData || soilData.length === 0) {
                document.getElementById("mapInfo").innerHTML = "í‘œì‹œí•  í† ì‚¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            // ì¤‘ë³µ ì œê±°ëœ ë°ì´í„° ì‚¬ìš© (í…Œì´ë¸”ê³¼ ë™ì¼í•œ ë¡œì§)
            const deduplicatedData = deduplicateAndSort(soilData);

            // ê°™ì€ ìœ„ì¹˜ì˜ ë§ˆì»¤ë“¤ì„ ì˜¤í”„ì…‹ì‹œí‚¤ëŠ” í•¨ìˆ˜
            const offsetMarkers = (markers) => {
                const positionMap = new Map();
                return markers.map((marker, index) => {
                    const key = `${marker.lat}_${marker.lng}`;
                    if (positionMap.has(key)) {
                        // ê°™ì€ ìœ„ì¹˜ë©´ ì•½ê°„ì”© ì˜¤í”„ì…‹
                        const offset = positionMap.get(key) * 0.0001; // ì•½ 10mì”© ì´ë™
                        return {
                            ...marker,
                            lat: marker.lat + offset,
                            lng: marker.lng + offset
                        };
                    } else {
                        positionMap.set(key, 1);
                        return marker;
                    }
                });
            };

            // ë§ˆì»¤ ì˜¤í”„ì…‹ ì ìš©
            const offsetData = offsetMarkers(deduplicatedData);

            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080'];
            
            offsetData.forEach((item, index) => {
                if (item.lat && item.lng) {
                    const color = colors[index % colors.length];
                    const position = new kakao.maps.LatLng(item.lat, item.lng);
                    
                    // ì§ì ‘ ëª©ì ì§€ì¸ì§€ ê²½ìœ ì§€ì¸ì§€ êµ¬ë¶„
                    const isDirect = item.is_direct || false;
                    const markerType = isDirect ? "ëª©ì ì§€" : "ê²½ìœ ì§€";
                    const markerIcon = isDirect ? "ğŸ¯" : "ğŸ“";
                    
                    // ë§ˆì»¤ ìƒì„±
                    const marker = new kakao.maps.Marker({
                        position: position,
                            map: map,
                        title: `${item.name}`
                    });
                    
                    // ìˆœìœ„ë³„ ìƒ‰ìƒ ì„¤ì •
                    const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32', '#4CAF50', '#2196F3']; // ê¸ˆ, ì€, ë™, ì´ˆë¡, íŒŒë‘
                    const rankColor = rankColors[index] || '#6c757d';
                    const rank = index + 1;
                    
                    // ë§ˆì»¤ ë²ˆí˜¸ ë° ìˆœìœ„ í‘œì‹œ
                    const markerNumber = new kakao.maps.CustomOverlay({
                        position: position,
                        content: `<div style="
                            background: ${rankColor}; 
                            color: white; 
                            width: 35px; 
                            height: 35px; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-weight: bold; 
                            font-size: 14px; 
                            border: 3px solid white;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        ">${rank}</div>`,
                        yAnchor: 0.5
                    });
                    
                    markerNumber.setMap(map);
                    
                    // ë§ˆì»¤ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ í‘œì‹œ
                    const infoWindow = new kakao.maps.InfoWindow({
                        content: `<div style="
                            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            padding: 12px;
                            min-width: 200px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            position: relative;
                        ">
                            <button id="closeBtn_${index}" 
                                    style="
                                        position: absolute; 
                                        top: 6px; 
                                        right: 6px; 
                                        background: #dc3545; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 50%; 
                                        width: 20px; 
                                        height: 20px; 
                                        font-size: 12px; 
                                        cursor: pointer; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center; 
                                        line-height: 1; 
                                        z-index: 1000;
                                        transition: all 0.2s ease;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                    " 
                                    onmouseover="this.style.background='#c82333'; this.style.transform='scale(1.1)'" 
                                    onmouseout="this.style.background='#dc3545'; this.style.transform='scale(1)'">Ã—</button>
                            
                            <div style="
                                margin: 0 0 8px 0; 
                                color: #2c3e50; 
                                font-size: 14px; 
                                font-weight: 700; 
                                padding-right: 25px; 
                                line-height: 1.2;
                                border-bottom: 1px solid #e9ecef;
                                padding-bottom: 6px;
                            ">
                                <span class="badge" style="background-color: ${rankColor}; color: white; font-size: 10px; margin-right: 8px;">${rank}ìˆœìœ„</span>
                                ${item.name}
                            </div>
                            
                            <div style="line-height: 1.4;">
                                <div style="
                                    margin-bottom: 6px; 
                                    padding: 4px 8px; 
                                    background: #f8f9fa; 
                                    border-radius: 4px; 
                                    border-left: 3px solid #007bff;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                ">
                                    <span style="color: #6c757d; font-weight: 600; font-size: 11px;">ìš©ëŸ‰</span>
                                    <span style="color: #2c3e50; font-weight: 700; font-size: 13px;">${(item.capacity_m3 || 0).toLocaleString()}mÂ³ (${item.soil_type})</span>
                                </div>
                                
                                <div style="
                                    margin-bottom: 6px; 
                                    padding: 4px 8px; 
                                    background: #f8f9fa; 
                                    border-radius: 4px; 
                                    border-left: 3px solid #28a745;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                ">
                                    <span style="color: #6c757d; font-weight: 600; font-size: 11px;">ê±°ë¦¬</span>
                                    <span style="color: #2c3e50; font-weight: 700; font-size: 13px;">${item.distance_km}km</span>
                                </div>
                                
                                <div style="
                                    padding: 4px 8px; 
                                    background: #f8f9fa; 
                                    border-radius: 4px; 
                                    border-left: 3px solid #6c757d;
                                    display: flex; 
                                    justify-content: space-between;
                                    align-items: center;
                                ">
                                    <span style="color: #6c757d; font-weight: 600; font-size: 11px;">ìš´ì†¡ë¹„</span>
                                    <span style="color: #2c3e50; font-weight: 700; font-size: 13px;">${calculateTransportCost((currentMatchingResult?.route?.entities?.volume_m3) || 500, item.distance_km).toLocaleString()}ì›</span>
                                </div>
                            </div>
                        </div>`,
                        position: position
                    });
                    
                    kakao.maps.event.addListener(marker, 'click', function() {
                        infoWindow.open(map, marker);
                        
                        // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€ (ì•½ê°„ì˜ ì§€ì—° í›„)
                        setTimeout(() => {
                            const closeBtn = document.getElementById(`closeBtn_${index}`);
                            if (closeBtn) {
                                closeBtn.addEventListener('click', function() {
                                    infoWindow.close();
                                });
                            }
                        }, 100);
                    });
                    
                    markers.push(marker);
                    markers.push(markerNumber);
                }
            });
            
            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (markers.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                deduplicatedData.forEach(item => {
                    if (item.lat && item.lng) {
                        bounds.extend(new kakao.maps.LatLng(item.lat, item.lng));
                    }
                });
                
                // ì‚¬ìš©ì ìœ„ì¹˜ë„ í¬í•¨
                if (userLocation) {
                    bounds.extend(new kakao.maps.LatLng(userLocation.lat, userLocation.lng));
                }
                
                map.setBounds(bounds);
            }
            
            document.getElementById("mapInfo").innerHTML = `${deduplicatedData.length}ê°œì˜ í† ì‚¬ ê³µê¸‰ì²˜ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`;
        }

        // ë§ˆì»¤ ì œê±°
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
        }

        // ê²½ë¡œ í‘œì‹œ í† ê¸€ í•¨ìˆ˜
        function toggleRoutes() {
            const routeBtn = document.getElementById('routeToggleBtn');
            
            if (isRouteMode) {
                // ê²½ë¡œ í‘œì‹œ ëª¨ë“œ í•´ì œ
                isRouteMode = false;
                routeBtn.classList.remove('active');
                clearRoutes();
                document.getElementById("mapInfo").innerHTML = "í† ì‚¬ ë§¤ì¹­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
            } else {
                // ê²½ë¡œ í‘œì‹œ ëª¨ë“œ í™œì„±í™”
                isRouteMode = true;
                routeBtn.classList.add('active');
                showRoutes(currentMatchingResult?.table);
                document.getElementById("mapInfo").innerHTML = "ê²½ë¡œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
        }

        // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜ (ì•ˆì „í•œ ë²„ì „)
        function showUserLocationMarker() {
            if (!userLocation) return;
            
            // ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì»¤ ì œê±°
            const existingUserMarker = markers.find(marker => marker.isUserLocation);
            if (existingUserMarker) {
                existingUserMarker.setMap(null);
                const index = markers.indexOf(existingUserMarker);
                if (index > -1) markers.splice(index, 1);
            }
            
            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ìƒì„± (ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš© - ì•ˆì „í•¨)
            const userMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                map: map,
                title: `ğŸš› ì¶œë°œì§€: ${userLocation.address || 'ì‚¬ìš©ì ìœ„ì¹˜'}`,
                zIndex: 15
            });
            
            userMarker.isUserLocation = true;
            markers.push(userMarker);
            
            // ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ì°½ (ë‹«ê¸° ë²„íŠ¼ í¬í•¨)
            const userInfoWindow = new kakao.maps.InfoWindow({
                content: `<div style="
                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 12px;
                    font-size: 13px;
                    font-weight: bold;
                    text-align: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    position: relative;
                    min-width: 200px;
                    border: 2px solid #3498db;
                ">
                    <button id="closeUserLocationBtn" 
                            style="
                                position: absolute; 
                                top: 6px; 
                                right: 6px; 
                                background: rgba(255,255,255,0.2); 
                                color: white; 
                                border: none; 
                                border-radius: 50%; 
                                width: 24px; 
                                height: 24px; 
                                font-size: 14px; 
                                cursor: pointer; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                line-height: 1; 
                                z-index: 1000;
                                transition: all 0.2s ease;
                            " 
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'">Ã—</button>
                    
                    <div style="margin: 0 0 8px 0; padding-right: 30px; color: #3498db;">
                        ğŸš› <strong>ì¶œë°œì§€</strong>
                    </div>
                    <div style="
                        background: rgba(52, 152, 219, 0.2);
                        padding: 6px 8px;
                        border-radius: 6px;
                        font-size: 11px;
                        font-weight: normal;
                        border: 1px solid rgba(52, 152, 219, 0.3);
                    ">
                        ${userLocation.address || 'ì‚¬ìš©ì ìœ„ì¹˜'}
                    </div>
                </div>`,
                position: new kakao.maps.LatLng(userLocation.lat, userLocation.lng)
            });
            
            kakao.maps.event.addListener(userMarker, 'click', function() {
                userInfoWindow.open(map, userMarker);
                
                // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€ (ì•½ê°„ì˜ ì§€ì—° í›„)
                setTimeout(() => {
                    const closeBtn = document.getElementById('closeUserLocationBtn');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', function() {
                            userInfoWindow.close();
                        });
                    }
                }, 100);
            });
        }

        // ì¤‘ë³µ ì œê±° ë° ì •ë ¬ í•¨ìˆ˜ (ê³µí†µ ì‚¬ìš©)
        function deduplicateAndSort(rows) {
            if (!rows || !rows.length) return [];
            
            // ì¤‘ë³µ ì œê±°: project_id ê¸°ë°˜ìœ¼ë¡œ ê³ ìœ í•œ ê³µê¸‰ì²˜ë§Œ ì„ íƒ
            const uniqueSuppliers = new Map();
            rows.forEach(item => {
                if (item.lat && item.lng && item.name) {
                    // project_idê°€ ìˆìœ¼ë©´ project_id ê¸°ë°˜, ì—†ìœ¼ë©´ name ê¸°ë°˜ìœ¼ë¡œ í‚¤ ìƒì„± (usage í¬í•¨)
                    const key = item.project_id ? 
                        `${item.project_id}_${item.usage || 'default'}_${item.is_direct ? 'direct' : 'waypoint'}` :
                        `${item.name}_${item.usage || 'default'}_${item.is_direct ? 'direct' : 'waypoint'}`;
                    
                    const existingItem = uniqueSuppliers.get(key);
                    
                    if (!existingItem) {
                        // ì²« ë²ˆì§¸ í•­ëª©
                        uniqueSuppliers.set(key, item);
                    } else {
                        // ê¸°ì¡´ í•­ëª©ê³¼ ë¹„êµí•˜ì—¬ ë” ì¢‹ì€ ì ìˆ˜ ì„ íƒ
                        const currentScore = parseFloat(item.score) || 0;
                        const existingScore = parseFloat(existingItem.score) || 0;
                        
                        if (currentScore > existingScore) {
                            // ë” ë†’ì€ ì ìˆ˜ë©´ êµì²´
                            uniqueSuppliers.set(key, item);
                        }
                    }
                }
            });

            const uniqueRows = Array.from(uniqueSuppliers.values());
            console.log(`ì¤‘ë³µ ì œê±°: ${rows.length}ê°œ â†’ ${uniqueRows.length}ê°œ`);
            
            // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
            uniqueRows.sort((a, b) => {
                const scoreA = parseFloat(a.score) || 0;
                const scoreB = parseFloat(b.score) || 0;
                return scoreB - scoreA; // ë‚´ë¦¼ì°¨ìˆœ
            });
            
            return uniqueRows;
        }

        // ê²½ë¡œ í‘œì‹œ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° ë° ìµœì í™”)
        function showRoutes(rows) {
            console.log('showRoutes í˜¸ì¶œë¨:', { userLocation, rows, rowsLen: rows?.length });
            if (!userLocation || !rows || !rows.length) {
                console.log('ê²½ë¡œ í‘œì‹œ ë°ì´í„° ë¶€ì¡±', { userLocation, rowsLen: rows?.length });
                return;
            }

            clearRoutes(); // ê¸°ì¡´ ê²½ë¡œ ì œê±°
            
            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
            showUserLocationMarker();

            // ì¤‘ë³µ ì œê±° ë° ì •ë ¬
            const uniqueRows = deduplicateAndSort(rows);

            // ì§ì ‘ ëª©ì ì§€ì™€ ê²½ìœ ì§€ êµ¬ë¶„
            const directDestinations = uniqueRows.filter(item => item.is_direct);
            const waypoints = uniqueRows.filter(item => !item.is_direct);
            
            console.log(`ì§ì ‘ ëª©ì ì§€: ${directDestinations.length}ê°œ, ê²½ìœ ì§€: ${waypoints.length}ê°œ`);

            const colors = ['#28a745', '#007bff', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080'];
            
            // ì§ì ‘ ëª©ì ì§€ ê²½ë¡œ (ë…¹ìƒ‰)
            directDestinations.forEach((item, index) => {
                if (item.lat && item.lng) {
                    drawRoute(userLocation.lat, userLocation.lng, item.lat, item.lng, colors[0], item.name, 'direct');
                }
            });
            
            // ê²½ìœ ì§€ ê²½ë¡œ (íŒŒë€ìƒ‰)
            waypoints.forEach((item, index) => {
                if (item.lat && item.lng) {
                    drawRoute(userLocation.lat, userLocation.lng, item.lat, item.lng, colors[1], item.name, 'waypoint');
                }
            });
            
            // ì§€ë„ ì¤‘ì‹¬ì„ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì´ë™
            const userLatLng = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
            map.setCenter(userLatLng);
            map.setLevel(8); // ì ì ˆí•œ í™•ëŒ€ ë ˆë²¨
        }

        // ê²½ë¡œ ë°ì´í„°ì—ì„œ ì‹¤ì œ ê²½ë¡œ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function drawRouteFromData(data, color, name, routeType = 'waypoint') {
                    // ê²½ë¡œ ì •ë³´ ì¶”ì¶œ
                const routes = data.data.routes;
                if (!routes || routes.length === 0) {
                    console.warn(`${name}: ê²½ë¡œ ë°ì´í„° ì—†ìŒ`);
                    return;
                }
                
                const route = routes[0];
                const sections = route.sections;
                if (!sections || sections.length === 0) {
                    console.warn(`${name}: ì„¹ì…˜ ë°ì´í„° ì—†ìŒ`);
                    return;
                }
                
                const section = sections[0];
                const roads = section.roads;
                if (!roads || roads.length === 0) {
                    console.warn(`${name}: ë„ë¡œ ë°ì´í„° ì—†ìŒ`);
                    return;
                }
                    
                    // ì‹¤ì œ ë„ë¡œ ê²½ë¡œ ì¢Œí‘œ ë°°ì—´
                    const path = [];
                roads.forEach(road => {
                    const vertexes = road.vertexes;
                    for (let i = 0; i < vertexes.length; i += 2) {
                        if (i + 1 < vertexes.length) {
                            const x = vertexes[i];     // ê²½ë„(lng)
                            const y = vertexes[i + 1]; // ìœ„ë„(lat)
                            // LatLngëŠ” (lat, lng) ìˆœì„œ!
                            path.push(new kakao.maps.LatLng(y, x));
                        }
                    }
                });
                
                if (path.length === 0) {
                    console.warn(`${name}: ê²½ë¡œ ì¢Œí‘œ ì—†ìŒ`);
                    return;
                }
                
                // ë””ë²„ê¹…: ì¢Œí‘œ í™•ì¸
                console.log(`${name}: ê²½ë¡œ ì¢Œí‘œ í™•ì¸`, path.slice(0, 3));
                    
                    // í´ë¦¬ë¼ì¸ìœ¼ë¡œ ê²½ë¡œ í‘œì‹œ
                    const polyline = new kakao.maps.Polyline({
                        path: path,
                    strokeWeight: 6,
                        strokeColor: color,
                    strokeOpacity: 0.9,
                    strokeStyle: 'solid', // ì‹¤ì œ ë„ë¡œëŠ” ì‹¤ì„ 
                    zIndex: 5
                    });
                    
                    polyline.setMap(map);
                    routePolylines.push(polyline);
                    
                    // ê²½ë¡œ ì •ë³´ (ê±°ë¦¬, ì‹œê°„)
                    const distance = section.distance; // ë¯¸í„° ë‹¨ìœ„
                    const duration = section.duration; // ì´ˆ ë‹¨ìœ„
                    
            // ê±°ë¦¬ì™€ ì‹œê°„ì„ ì ì ˆí•œ ë‹¨ìœ„ë¡œ ë³€í™˜
            const distanceKm = (distance / 1000).toFixed(1);
            const durationMin = Math.round(duration / 60);
            
            console.log(`${name}: ${distanceKm}km, ${durationMin}ë¶„ ê²½ë¡œ í‘œì‹œ ì™„ë£Œ`);
            
            // ê²½ë¡œ ì •ë³´ë¥¼ í´ë¦¬ë¼ì¸ì— ì €ì¥ (ë‚˜ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡)
            polyline.routeInfo = {
                name: name,
                distance: distanceKm,
                duration: durationMin,
                type: routeType
            };
        }

        // ê°œë³„ ê²½ë¡œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ìºì‹± í¬í•¨)
        function drawRoute(startLat, startLng, endLat, endLng, color, name, routeType = 'waypoint') {
            console.log(`ê²½ë¡œ ê·¸ë¦¬ê¸° ì‹œì‘: ${name} (${startLat}, ${startLng}) â†’ (${endLat}, ${endLng}) - íƒ€ì…: ${routeType}`);
            
            // ìºì‹œ í‚¤ ìƒì„± (ì¢Œí‘œ ê¸°ë°˜)
            const cacheKey = `${startLat.toFixed(4)},${startLng.toFixed(4)}-${endLat.toFixed(4)},${endLng.toFixed(4)}`;
            
            // ìºì‹œ í™•ì¸
            if (routeCache.has(cacheKey)) {
                console.log(`${name}: ìºì‹œëœ ê²½ë¡œ ì‚¬ìš©`);
                const cachedData = routeCache.get(cacheKey);
                drawRouteFromData(cachedData, color, name, routeType);
                return;
            }
            
            // ì„œë²„ì—ì„œ ì‹¤ì œ ë„ë¡œ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            fetch('/directions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    origin_lat: startLat,
                    origin_lng: startLng,
                    dest_lat: endLat,
                    dest_lng: endLng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.warn(`${name}: ì„œë²„ API ì‹¤íŒ¨ - ${data.message}`);
                    drawStraightRoute(startLat, startLng, endLat, endLng, color, name);
                    return;
                }
                
                console.log(`${name}: ì„œë²„ Directions API ì„±ê³µ`);
                
                // ìºì‹œì— ì €ì¥
                routeCache.set(cacheKey, data);
                
                // ê²½ë¡œ ë°ì´í„° ì²˜ë¦¬
                drawRouteFromData(data, color, name, routeType);
            })
            .catch(error => {
                console.error(`${name}: ì„œë²„ API ì˜¤ë¥˜`, error);
                    drawStraightRoute(startLat, startLng, endLat, endLng, color, name);
            });
        }
        
        // ì§ì„  ê²½ë¡œ ëŒ€ì²´ í•¨ìˆ˜ (API ì‹¤íŒ¨ ì‹œ)
        function drawStraightRoute(startLat, startLng, endLat, endLng, color, name) {
            const startPoint = new kakao.maps.LatLng(startLat, startLng);
            const endPoint = new kakao.maps.LatLng(endLat, endLng);
            const path = [startPoint, endPoint];
            
            const polyline = new kakao.maps.Polyline({
                path: path,
                strokeWeight: 6,
                strokeColor: color,
                strokeOpacity: 0.9,
                strokeStyle: 'dashed',
                zIndex: 5
            });
            
            polyline.setMap(map);
            routePolylines.push(polyline);
            
            const distance = calculateDistance(startLat, startLng, endLat, endLng);
            const midLat = (startLat + endLat) / 2;
            const midLng = (startLng + endLng) / 2;
            const midPoint = new kakao.maps.LatLng(midLat, midLng);
            
            const infoWindow = new kakao.maps.InfoWindow({
                content: `<div style="padding: 5px; font-size: 12px; text-align: center;">
                    <strong>${name}</strong><br>
                    <span style="color: #dc3545;">ì§ì„ ê±°ë¦¬: ${distance.toFixed(1)}km</span><br>
                    <small style="color: #6c757d;">(ì‹¤ì œ ë„ë¡œ ê²½ë¡œ ë¶ˆê°€)</small>
                </div>`,
                position: midPoint
            });
            
            const marker = new kakao.maps.Marker({
                position: midPoint,
                map: map,
                title: `${name} - ì§ì„ ê±°ë¦¬ ${distance.toFixed(1)}km`
            });
            
            kakao.maps.event.addListener(marker, 'click', function() {
                infoWindow.open(map, marker);
            });
            
            routePolylines.push(marker);
        }

        // ê²½ë¡œ ì œê±° í•¨ìˆ˜
        function clearRoutes() {
            routePolylines.forEach(item => {
                if (item.setMap) {
                    item.setMap(null);
                }
            });
            routePolylines = [];
            totalDuration = 0;
            routeCount = 0;
        }
        
        // ì´ ì†Œìš”ì‹œê°„ ë° ë¤í”„íŠ¸ëŸ­ ëŒ€ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTotalDuration(duration) {
            totalDuration += duration;
            routeCount++;
            
            // ëª¨ë“  ê²½ë¡œê°€ ì™„ë£Œë˜ë©´ ì´ ì†Œìš”ì‹œê°„ ë° ë¤í”„íŠ¸ëŸ­ ëŒ€ìˆ˜ í‘œì‹œ
            if (currentMatchingResult && currentMatchingResult.table) {
                const expectedRoutes = currentMatchingResult.table.length;
                if (routeCount >= expectedRoutes) {
                    const totalMinutes = Math.floor(totalDuration / 60);
                    const totalHours = Math.floor(totalMinutes / 60);
                    const remainingMinutes = totalMinutes % 60;
                    
                    let timeText = '';
                    if (totalHours > 0) {
                        timeText = `${totalHours}ì‹œê°„ ${remainingMinutes}ë¶„`;
                    } else {
                        timeText = `${totalMinutes}ë¶„`;
                    }
                    
                    // ë¤í”„íŠ¸ëŸ­ ëŒ€ìˆ˜ ê³„ì‚° (ìš”ì²­ëŸ‰ ê¸°ì¤€)
                    const demandVolume = currentMatchingResult?.route?.entities?.volume_m3 || 500; // ê¸°ë³¸ê°’ 500mÂ³
                    const dumpTruckCount = Math.ceil(demandVolume / 25); // 25mÂ³ë‹¹ 1ëŒ€
                    
                    document.getElementById("mapInfo").innerHTML = 
                        `${expectedRoutes}ê°œì˜ í† ì‚¬ ê³µê¸‰ì²˜ì™€ ê²½ë¡œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                         <strong style="color: #28a745;">ì´ ì˜ˆìƒì†Œìš”ì‹œê°„: ${timeText}</strong><br>
                         <strong style="color: #ffc107;">ğŸš› í•„ìš” ë¤í”„íŠ¸ëŸ­: ${dumpTruckCount}ëŒ€ (${demandVolume}mÂ³ ê¸°ì¤€)</strong>`;
                }
            }
        }

        // ì§„í–‰ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
        function getProgressColor(progress) {
            if (progress >= 80) return '#28a745'; // ë…¹ìƒ‰
            if (progress >= 60) return '#ffc107'; // ë…¸ë€ìƒ‰
            if (progress >= 40) return '#fd7e14'; // ì£¼í™©ìƒ‰
            return '#dc3545'; // ë¹¨ê°„ìƒ‰
        }
        
        // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
        function formatNumber(num) {
            if (!num) return '0';
            return num.toLocaleString();
        }
        
        // ìš´ì†¡ë¹„ ê³„ì‚° í•¨ìˆ˜ (ìƒˆë¡œìš´ ì‚°ì‹)
        function calculateTransportCost(soilVolume, distance) {
            if (!soilVolume || !distance) return 0;
            
            // ê¸°ë³¸ ê³µì‹: 5 + 3.7142857 * ìš´ë°˜ê±°ë¦¬
            const baseFormula = 5 + 3.7142857 * distance;
            
            // 3ê°œ í•­ëª© ê³„ì‚°
            const item1 = Math.trunc(Math.round(48567 / Math.round(720.144 / Math.round(14.56 + Math.round(baseFormula, 2), 2), 2), 1) + 383);
            const item2 = Math.trunc(Math.round(57077 / Math.round(720.144 / Math.round(14.56 + Math.round(baseFormula, 2), 2), 2), 1) + 808.9);
            const item3 = Math.trunc(Math.round(32323 / Math.round(720.144 / Math.round(14.56 + Math.round(baseFormula, 2), 2), 2), 1) + 483.5);
            
            // ìµœì¢… ê³„ì‚°: í† ì„ëŸ‰ * (í•­ëª©1 + í•­ëª©2 + í•­ëª©3)
            return Math.trunc(soilVolume * (item1 + item2 + item3));
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // í† ì§€ ì´ìš© í˜„í™© í† ê¸€ í•¨ìˆ˜
        function toggleLanduse() {
            const landuseBtn = document.getElementById('landuseToggleBtn');
            
            if (isLanduseMode) {
                isLanduseMode = false;
                landuseBtn.classList.remove('active');
                document.getElementById("mapInfo").innerHTML = "í† ì‚¬ ë§¤ì¹­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
            } else {
                isLanduseMode = true;
                landuseBtn.classList.add('active');
                loadLanduseData();
            }
        }

        // í† ì§€ ì´ìš© í˜„í™© ë°ì´í„° ë¡œë“œ
        function loadLanduseData() {
            console.log('=== í† ì§€ ì´ìš© í˜„í™© ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
            document.getElementById("mapInfo").innerHTML = "í† ì§€ ì´ìš© í˜„í™© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            
            // í˜„ì¬ ë§¤ì¹­ ê²°ê³¼ì—ì„œ ì£¼ì†Œ ì¶”ì¶œ
            if (!currentResults || !currentResults.results || currentResults.results.length === 0) {
                console.log('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                document.getElementById("mapInfo").innerHTML = "ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            console.log('í˜„ì¬ ê²°ê³¼:', currentResults);
            
            // ì¶œë°œì§€ì™€ ëª©ì ì§€ ì£¼ì†Œ ìˆ˜ì§‘
            const addresses = [];
            
            // ì¶œë°œì§€ ì£¼ì†Œ ì¶”ê°€ (detailed_address ìš°ì„  ì‚¬ìš©)
            if (currentResults.origin) {
                const originAddress = currentResults.origin.detailed_address || currentResults.origin.address;
                console.log('ì¶œë°œì§€ ì£¼ì†Œ:', originAddress);
                addresses.push(originAddress);
            }
            
            // ëª©ì ì§€ ì£¼ì†Œë“¤ ì¶”ê°€ (ìƒìœ„ 3ê°œ)
            currentResults.results.slice(0, 3).forEach((result, index) => {
                console.log(`ëª©ì ì§€ ${index + 1} ì£¼ì†Œ:`, result.address);
                addresses.push(result.address);
            });
            
            console.log('ì „ì²´ ì£¼ì†Œ ëª©ë¡:', addresses);
            
            // ì£¼ì†Œì—ì„œ ì§€ì—­ ì¶”ì¶œ ë° ì¤‘ë³µ ì œê±°
            const regions = extractRegionsFromAddresses(addresses);
            const uniqueRegions = deduplicateRegions(regions);
            
            console.log('=== í† ì§€ ì´ìš© í˜„í™© ë””ë²„ê¹… ===');
            console.log('ìˆ˜ì§‘ëœ ì£¼ì†Œë“¤:', addresses);
            console.log('ì¶”ì¶œëœ ì§€ì—­ë“¤:', regions);
            console.log('ì¤‘ë³µ ì œê±°ëœ ì§€ì—­ë“¤:', uniqueRegions);
            console.log('ì´ ì£¼ì†Œ ê°œìˆ˜:', addresses.length);
            console.log('ì´ ì§€ì—­ ê°œìˆ˜:', regions.length);
            console.log('ì¤‘ë³µ ì œê±° í›„ ì§€ì—­ ê°œìˆ˜:', uniqueRegions.length);
            
            if (uniqueRegions.length === 0) {
                document.getElementById("mapInfo").innerHTML = "ì§€ì—­ ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            // ê° ì§€ì—­ë³„ë¡œ í† ì§€ ì´ìš© í˜„í™© ë°ì´í„° ìš”ì²­
            const promises = uniqueRegions.map(region => 
                fetch(`/landuse/${encodeURIComponent(region)}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`ì§€ì—­ ${region} API ì‘ë‹µ:`, data);
                        return { region, data };
                    })
                    .catch(error => {
                        console.error(`ì§€ì—­ ${region} API ì˜¤ë¥˜:`, error);
                        return { region, error: error.message };
                    })
            );
            
            Promise.all(promises).then(results => {
                displayLanduseData(results);
            });
        }
        
        // ì£¼ì†Œì—ì„œ ì§€ì—­ ì¶”ì¶œ
        function extractRegionsFromAddresses(addresses) {
            const regions = [];
            
            addresses.forEach(address => {
                const region = extractRegionFromAddress(address);
                if (region) {
                    regions.push(region);
                }
            });
            
            return regions;
        }
        
        // ê°œë³„ ì£¼ì†Œì—ì„œ ìµœí•˜ìœ„ í–‰ì •êµ¬ì—­ ì¶”ì¶œ
        function extractRegionFromAddress(address) {
            console.log('ì£¼ì†Œ ì¶”ì¶œ ì‹œë„:', address);
            
            // ì£¼ì†Œì—ì„œ ê´„í˜¸ë‚˜ íŠ¹ìˆ˜ë¬¸ì ì œê±°
            const cleanAddress = address.replace(/\([^)]*\)/g, '').replace(/[^\w\sê°€-í£]/g, ' ').trim();
            console.log('ì •ë¦¬ëœ ì£¼ì†Œ:', cleanAddress);
            
            // 1ë‹¨ê³„: ë¦¬/ë™ ì¶”ì¶œ (ê°€ì¥ êµ¬ì²´ì )
            let riMatch = cleanAddress.match(/([ê°€-í£]+(?:ë¦¬|ë™))/);
            if (riMatch) {
                const ri = riMatch[1];
                console.log('ë¦¬/ë™ ë°œê²¬:', ri);
                
                // ì/ë©´/ë™ ì°¾ê¸°
                const eupMyeonDongMatch = cleanAddress.match(/([ê°€-í£]+(?:ì|ë©´|ë™))/);
                if (eupMyeonDongMatch) {
                    const eupMyeonDong = eupMyeonDongMatch[1];
                    console.log('ì/ë©´/ë™ ë°œê²¬:', eupMyeonDong);
                    
                    // ì‹œ/êµ°/êµ¬ ì°¾ê¸° (íŠ¹ë³„ì‹œ/ê´‘ì—­ì‹œ ì œì™¸) - ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ë°©ë²•
                    const siGunGuMatch = cleanAddress.match(/([ê°€-í£]+(?:ì‹œ|êµ°|êµ¬))(?![ê°€-í£]*(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ))/);
                    if (siGunGuMatch) {
                        const siGunGu = siGunGuMatch[1];
                        console.log('ì‹œ/êµ°/êµ¬ ë°œê²¬:', siGunGu);
                        
                        // ë„ ì°¾ê¸° (ì„œìš¸íŠ¹ë³„ì‹œ, ë¶€ì‚°ê´‘ì—­ì‹œ ë“± í¬í•¨)
                        let doMatch = cleanAddress.match(/([ê°€-í£]+(?:íŠ¹ë³„ìì¹˜ë„|íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ë„))/);
                        if (!doMatch) {
                            // ì„œìš¸ ì•½ì¹­ ì²˜ë¦¬
                            if (cleanAddress.includes('ì„œìš¸')) {
                                doMatch = ['ì„œìš¸', 'ì„œìš¸íŠ¹ë³„ì‹œ'];
                            }
                            // ê²½ë¶ ì•½ì¹­ ì²˜ë¦¬
                            else if (cleanAddress.includes('ê²½ë¶')) {
                                doMatch = ['ê²½ë¶', 'ê²½ìƒë¶ë„'];
                            }
                        }
                        
                        if (doMatch) {
                            const doName = doMatch[1] === 'ì„œìš¸' ? 'ì„œìš¸íŠ¹ë³„ì‹œ' : 
                                          doMatch[1] === 'ê²½ë¶' ? 'ê²½ìƒë¶ë„' : doMatch[1];
                            
                            // ë¦¬ì™€ ë™ì´ ë‹¤ë¥¸ ê²½ìš° (êµ¬ì—­ë‹¨ìœ„4ê°€ ìˆëŠ” ê²½ìš°)
                            if (ri !== eupMyeonDong) {
                                const result = `${doName} ${siGunGu} ${eupMyeonDong} ${ri}`;
                                console.log('íŒ¨í„´ ë§¤ì¹­ (êµ¬ì—­ë‹¨ìœ„4):', result);
                                return result;
                            } else {
                                // ë¦¬ì™€ ë™ì´ ê°™ì€ ê²½ìš° (êµ¬ì—­ë‹¨ìœ„3ê¹Œì§€ë§Œ ìˆëŠ” ê²½ìš°)
                                const result = `${doName} ${siGunGu} ${eupMyeonDong}`;
                                console.log('íŒ¨í„´ ë§¤ì¹­ (êµ¬ì—­ë‹¨ìœ„3):', result);
                                return result;
                            }
                        }
                    }
                }
            }
            
            // 2ë‹¨ê³„: ì/ë©´/ë™ê¹Œì§€ë§Œ (êµ¬ì—­ë‹¨ìœ„3)
            const eupMyeonDongMatch = cleanAddress.match(/([ê°€-í£]+(?:ì|ë©´|ë™))/);
            if (eupMyeonDongMatch) {
                const eupMyeonDong = eupMyeonDongMatch[1];
                console.log('ì/ë©´/ë™ ë°œê²¬ (2ë‹¨ê³„):', eupMyeonDong);
                
                const siGunGuMatch = cleanAddress.match(/([ê°€-í£]+(?:ì‹œ|êµ°|êµ¬))(?![ê°€-í£]*(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ))/);
                if (siGunGuMatch) {
                    const siGunGu = siGunGuMatch[1];
                    console.log('ì‹œ/êµ°/êµ¬ ë°œê²¬ (2ë‹¨ê³„):', siGunGu);
                    
                    let doMatch = cleanAddress.match(/([ê°€-í£]+(?:íŠ¹ë³„ìì¹˜ë„|íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ë„))/);
                    if (!doMatch) {
                        if (cleanAddress.includes('ì„œìš¸')) {
                            doMatch = ['ì„œìš¸', 'ì„œìš¸íŠ¹ë³„ì‹œ'];
                        }
                        else if (cleanAddress.includes('ê²½ë¶')) {
                            doMatch = ['ê²½ë¶', 'ê²½ìƒë¶ë„'];
                        }
                    }
                    
                    if (doMatch) {
                        const doName = doMatch[1] === 'ì„œìš¸' ? 'ì„œìš¸íŠ¹ë³„ì‹œ' : 
                                      doMatch[1] === 'ê²½ë¶' ? 'ê²½ìƒë¶ë„' : doMatch[1];
                        const result = `${doName} ${siGunGu} ${eupMyeonDong}`;
                        console.log('íŒ¨í„´ ë§¤ì¹­ (êµ¬ì—­ë‹¨ìœ„3):', result);
                        return result;
                    }
                }
            }
            
            // 3ë‹¨ê³„: ì‹œ/êµ°/êµ¬ê¹Œì§€ë§Œ (êµ¬ì—­ë‹¨ìœ„2)
            const siGunGuMatch = cleanAddress.match(/([ê°€-í£]+(?:ì‹œ|êµ°|êµ¬))(?![ê°€-í£]*(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ))/);
            if (siGunGuMatch) {
                const siGunGu = siGunGuMatch[1];
                console.log('ì‹œ/êµ°/êµ¬ ë°œê²¬ (3ë‹¨ê³„):', siGunGu);
                
                let doMatch = cleanAddress.match(/([ê°€-í£]+(?:íŠ¹ë³„ìì¹˜ë„|íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ë„))/);
                if (!doMatch) {
                    if (cleanAddress.includes('ì„œìš¸')) {
                        doMatch = ['ì„œìš¸', 'ì„œìš¸íŠ¹ë³„ì‹œ'];
                    }
                    else if (cleanAddress.includes('ê²½ë¶')) {
                        doMatch = ['ê²½ë¶', 'ê²½ìƒë¶ë„'];
                    }
                }
                
                if (doMatch) {
                    const doName = doMatch[1] === 'ì„œìš¸' ? 'ì„œìš¸íŠ¹ë³„ì‹œ' : 
                                  doMatch[1] === 'ê²½ë¶' ? 'ê²½ìƒë¶ë„' : doMatch[1];
                    const result = `${doName} ${siGunGu}`;
                    console.log('íŒ¨í„´ ë§¤ì¹­ (êµ¬ì—­ë‹¨ìœ„2):', result);
                    return result;
                }
            }
            
            console.log('ë§¤ì¹­ ì‹¤íŒ¨:', address);
            return null;
        }
        
        // ì¤‘ë³µ ì§€ì—­ ì œê±° (ê°™ì€ ìµœí•˜ìœ„ í–‰ì •êµ¬ì—­ì´ë©´ í•˜ë‚˜ë§Œ ìœ ì§€)
        function deduplicateRegions(regions) {
            const uniqueRegions = [];
            const seen = new Set();
            
            regions.forEach(region => {
                if (!seen.has(region)) {
                    seen.add(region);
                    uniqueRegions.push(region);
                }
            });
            
            console.log('ì¤‘ë³µ ì œê±° ì „:', regions);
            console.log('ì¤‘ë³µ ì œê±° í›„:', uniqueRegions);
            
            return uniqueRegions;
        }
        
        // í† ì§€ ì´ìš© í˜„í™© ë°ì´í„° í‘œì‹œ
        function displayLanduseData(results) {
            console.log('displayLanduseData í˜¸ì¶œ, results:', results);
            
            const validResults = results.filter(result => !result.error && result.data && !result.data.error);
            
            console.log('ìœ íš¨í•œ ê²°ê³¼ ê°œìˆ˜:', validResults.length);
            console.log('ìœ íš¨í•œ ê²°ê³¼ë“¤:', validResults);
            
            if (validResults.length === 0) {
                document.getElementById("mapInfo").innerHTML = "í† ì§€ ì´ìš© í˜„í™© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            let html = '<div class="landuse-results">';
            
            validResults.forEach(({ region, data }, index) => {
                html += `
                    <div class="landuse-chart-container">
                        <div class="landuse-chart-title">${region}</div>
                        <div class="landuse-chart-wrapper">
                            <canvas id="landuseChart${index}"></canvas>
                        </div>
                        <div class="landuse-legend">
                            <div class="landuse-legend-item">
                                <div class="landuse-legend-color" style="background-color: #28a745;"></div>
                                <span><strong>ë…¼:</strong> ${data.data.ë…¼}ha (${data.data.ë…¼_ë¹„ìœ¨}%)</span>
                            </div>
                            <div class="landuse-legend-item">
                                <div class="landuse-legend-color" style="background-color: #ffc107;"></div>
                                <span><strong>ë°­:</strong> ${data.data.ë°­}ha (${data.data.ë°­_ë¹„ìœ¨}%)</span>
                            </div>
                            <div class="landuse-legend-item">
                                <div class="landuse-legend-color" style="background-color: #17a2b8;"></div>
                                <span><strong>ê³¼ìˆ˜:</strong> ${data.data.ê³¼ìˆ˜}ha (${data.data.ê³¼ìˆ˜_ë¹„ìœ¨}%)</span>
                            </div>
                            <div class="landuse-legend-item">
                                <div class="landuse-legend-color" style="background-color: #dc3545;"></div>
                                <span><strong>ì´ˆì§€:</strong> ${data.data.ì´ˆì§€}ha (${data.data.ì´ˆì§€_ë¹„ìœ¨}%)</span>
                            </div>
                            <div class="landuse-legend-item">
                                <div class="landuse-legend-color" style="background-color: #6c757d;"></div>
                                <span><strong>ì„ì§€:</strong> ${data.data.ì„ì§€}ha (${data.data.ì„ì§€_ë¹„ìœ¨}%)</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById("mapInfo").innerHTML = html;
            
            // ì°¨íŠ¸ ìƒì„±
            createLanduseCharts(validResults);
        }
        
        // í† ì§€ ì´ìš© í˜„í™© ì°¨íŠ¸ ìƒì„±
        function createLanduseCharts(validResults) {
            console.log('ì°¨íŠ¸ ìƒì„± ì‹œì‘, validResults ê°œìˆ˜:', validResults.length);
            
            // Chart.js ë¡œë”© ëŒ€ê¸°
            let retryCount = 0;
            const maxRetries = 10;
            
            const createCharts = () => {
                if (typeof Chart === 'undefined') {
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        console.error('Chart.js ë¡œë“œ ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
                        return;
                    }
                    setTimeout(createCharts, 200);
                    return;
                }
                
                console.log('Chart.js ë¡œë“œ ì™„ë£Œ, ì°¨íŠ¸ ìƒì„± ì‹œì‘');
                
                // DOMì´ ì™„ì „íˆ ë Œë”ë§ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            setTimeout(() => {
                    validResults.forEach(({ region, data }, index) => {
                        console.log(`ì°¨íŠ¸ ìƒì„± ì‹œë„: index=${index}, region=${region}`);
                        createLanduseChart(index, data.data, region);
                    });
                }, 200);
            };
            
            setTimeout(createCharts, 500);
        }
        
        // ê°œë³„ í† ì§€ ì´ìš© í˜„í™© ì°¨íŠ¸ ìƒì„±
        function createLanduseChart(index, landuse, region) {
            const ctx = document.getElementById(`landuseChart${index}`);
            if (!ctx) {
                console.error(`Canvas ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: landuseChart${index}`);
                return;
            }
            
            console.log(`ì°¨íŠ¸ ìƒì„± ì¤‘: index=${index}, region=${region}, landuse=`, landuse);
            
            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì œê±°
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            try {
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ë…¼', 'ë°­', 'ê³¼ìˆ˜', 'ì´ˆì§€', 'ì„ì§€'],
                        datasets: [{
                            data: [landuse.ë…¼, landuse.ë°­, landuse.ê³¼ìˆ˜, landuse.ì´ˆì§€, landuse.ì„ì§€],
                            backgroundColor: [
                                '#28a745', // ë…¼ - ë…¹ìƒ‰
                                '#ffc107', // ë°­ - ë…¸ë€ìƒ‰
                                '#17a2b8', // ê³¼ìˆ˜ - ì²­ìƒ‰
                                '#dc3545', // ì´ˆì§€ - ë¹¨ê°„ìƒ‰
                                '#6c757d'  // ì„ì§€ - íšŒìƒ‰
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // ë²”ë¡€ëŠ” HTMLë¡œ ë³„ë„ í‘œì‹œ
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value}ha (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ canvas ìš”ì†Œì— ì €ì¥
                ctx.chart = chart;
                console.log(`ì°¨íŠ¸ ìƒì„± ì™„ë£Œ: index=${index}, region=${region}`);
            } catch (error) {
                console.error(`ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜: index=${index}, region=${region}`, error);
            }
        }

        // DOM ìš”ì†Œ
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loading = document.getElementById('loading');

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, 'user');
            messageInput.value = '';

            // ë¡œë”© í‘œì‹œ
            showLoading();

            // API í˜¸ì¶œ
            fetch('/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: message })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                handleResponse(data);
            })
            .catch(error => {
                hideLoading();
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot');
                console.error('Error:', error);
            });
        }

        // ì˜ˆì‹œ ì¿¼ë¦¬ ì „ì†¡
        function sendExampleQuery(query) {
            messageInput.value = query;
            sendMessage();
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ì‘ë‹µ ì²˜ë¦¬
        function handleResponse(data) {
            if (data.error) {
                addMessage(`ì˜¤ë¥˜: ${data.message}`, 'bot');
                return;
            }

            let responseText = '';

            // ì˜ë„ë³„ ì‘ë‹µ ì²˜ë¦¬
            if (data.route && data.route.intent === 'MATCH_FIND') {
                // ì§€ì—­ ì •ë³´ ì €ì¥
                if (data.route.entities && data.route.entities.region) {
                    currentRegion = data.route.entities.region;
                }
                
                if (data.table && data.table.length > 0) {
                    responseText = `ğŸ” <strong>í† ì‚¬ ë§¤ì¹­ ê²°ê³¼</strong><br><br>`;
                    
                    // ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ ì €ì¥
                    if (data.user_location) {
                        userLocation = data.user_location;
                        console.log('ì‚¬ìš©ì ìœ„ì¹˜ ì„¤ì •:', userLocation);
                    }
                    
                    // ìš”ì•½ ì •ë³´
                    if (data.summary) {
                        responseText += `<small class="text-muted">${data.summary.join(', ')}</small><br><br>`;
                    }
                    
                    // ê²°ê³¼ í…Œì´ë¸”
                    responseText += `<div class="result-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ìˆœìœ„</th>
                                    <th>ê³µê¸‰ì²˜</th>
                                    <th>ê±°ë¦¬</th>
                                    <th>ê°€ìš© ê³µê¸‰ëŸ‰<br><small>(ã¥)</small></th>
                                    <th>í† ì„ìœ í˜•</th>
                                    <th>ì í•©ìš©ë„</th>
                                    <th>ìš´ì†¡ë¹„<br><small>(ì›/ã¥Â·km)</small></th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    // ì¤‘ë³µ ì œê±°ëœ ë°ì´í„° ì‚¬ìš© (ì§€ë„ì™€ ë™ì¼í•œ ë¡œì§)
                    const deduplicatedData = deduplicateAndSort(data.table);
                    deduplicatedData.forEach((item, index) => {
                        // ì§„í–‰ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
                        const progressRatio = item.progress_ratio || 0;
                        const progressPercent = Math.round(progressRatio * 100);
                        let progressColor = '#6c757d'; // ê¸°ë³¸ íšŒìƒ‰
                        if (progressRatio > 0.8) progressColor = '#dc3545'; // ë¹¨ê°„ìƒ‰ (ê¸´ê¸‰)
                        else if (progressRatio > 0.6) progressColor = '#fd7e14'; // ì£¼í™©ìƒ‰ (ì£¼ì˜)
                        else if (progressRatio > 0.4) progressColor = '#ffc107'; // ë…¸ë€ìƒ‰ (ë³´í†µ)
                        else if (progressRatio > 0.2) progressColor = '#20c997'; // ì²­ë¡ìƒ‰ (ì—¬ìœ )
                        else progressColor = '#28a745'; // ì´ˆë¡ìƒ‰ (ì—¬ìœ )
                        
                        // ìš´ì†¡ë¹„ ê³„ì‚° (ìƒˆë¡œìš´ ì‚°ì‹ ì ìš©)
                        const userVolume = data.route?.entities?.volume_m3 || 500; // ì‚¬ìš©ì ìš”ì²­ëŸ‰
                        const calculatedTransportCost = calculateTransportCost(userVolume, item.distance_km);
                        const transportCost = calculatedTransportCost.toLocaleString();
                        
                        // ê³µê¸‰ì²˜ ëª…ì„ ë” ì½ê¸° ì‰½ê²Œ ì²˜ë¦¬
                        const supplierName = item.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                        const displayName = supplierName.length > 20 ? 
                            supplierName.substring(0, 20) + '...' : 
                            supplierName;
                        
                        // ìœ í˜• ì •ë³´ ê²°ì •
                        const isDirect = item.is_direct;
                        const typeText = isDirect ? 'ë‹¨ë…' : 'ê²½ìœ ì§€';
                        const typeColor = isDirect ? '#28a745' : '#007bff';
                        const typeIcon = isDirect ? 'ğŸ¯' : 'ğŸ”„';
                        
                        // ì¡°í•© ì •ë³´ ì²˜ë¦¬
                        let combinationInfo = '';
                        if (item.combination_details && !isDirect) {
                            const details = item.combination_details;
                            const waypointNames = details.waypoints.map(wp => `${wp.name} (${wp.volume}mÂ³)`).join(', ');
                            const finalInfo = `${details.final_destination.name} (${details.final_destination.volume}mÂ³)`;
                            combinationInfo = `<br><small style="color: #6c757d; font-size: 11px;">
                                ${waypointNames}<br>
                                ìµœì¢…ëª©ì ì§€: ${finalInfo}
                            </small>`;
                        }
                        
                        // ìˆœìœ„ ì •ë³´
                        const rank = index + 1;
                        const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32', '#4CAF50', '#2196F3']; // ê¸ˆ, ì€, ë™, ì´ˆë¡, íŒŒë‘
                        const rankColor = rankColors[index] || '#6c757d';
                        
                        responseText += `
                            <tr>
                                <td><span class="badge rank-badge" style="background-color: ${rankColor}; color: white; font-weight: bold; font-size: 12px; display: block; margin: 0 auto; text-align: center; width: fit-content;">${rank}ìˆœìœ„</span></td>
                                <td class="col-supplier" title="${supplierName}${combinationInfo}">${displayName}${combinationInfo}</td>
                                <td>${item.distance_km}km</td>
                                <td><strong style="color: #007bff;">${(item.current_capacity_m3 || 0).toLocaleString()}</strong></td>
                                <td>${item.type || 'ë¶ˆëª…'}</td>
                                <td>${item.usage || 'ë¶ˆëª…'}</td>
                                <td><strong style="color: #dc3545;">${transportCost}</strong></td>
                            </tr>`;
                    });
                    
                    responseText += `</tbody></table></div>`;
                    
                    // ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
                    addSoilMarkers(data.table);
                    
                    // ë§¤ì¹­ ê²°ê³¼ ì €ì¥ (ê²½ë¡œ í‘œì‹œìš©)
                    currentMatchingResult = data;
                    console.log('ë§¤ì¹­ ê²°ê³¼ ì €ì¥ ì™„ë£Œ:', currentMatchingResult);
                    
                    // í† ì§€ ì´ìš© í˜„í™©ìš© ê²°ê³¼ ì €ì¥
                    currentResults = {
                        origin: data.origin || data.user_location,
                        results: data.table || []
                    };
                    console.log('í† ì§€ ì´ìš© í˜„í™©ìš© ê²°ê³¼ ì €ì¥ ì™„ë£Œ:', currentResults);
                    
                    // ê²½ë¡œ í‘œì‹œ (ì¤‘ë³µ ì‹¤í–‰ ì œê±°)
                    if (data.user_location && data.table?.length) {
                        console.log('ê²½ë¡œ í‘œì‹œ ì‹œì‘');
                            
                            // ê²½ë¡œ í‘œì‹œ ëª¨ë“œ í™œì„±í™”
                            isRouteMode = true;
                            const routeBtn = document.getElementById('routeToggleBtn');
                            if (routeBtn) {
                                routeBtn.classList.add('active');
                            }
                            
                        // ë‹¨ì¼ ê²½ë¡œ í‘œì‹œ ì‹¤í–‰
                        showRoutes(data.table);
                        
                        // ë¤í”„íŠ¸ëŸ­ ëŒ€ìˆ˜ ê³„ì‚° (ìš”ì²­ëŸ‰ ê¸°ì¤€)
                        const demandVolume = data.route?.entities?.volume_m3 || 500; // ê¸°ë³¸ê°’ 500mÂ³
                        const dumpTruckCount = Math.ceil(demandVolume / 25); // 25mÂ³ë‹¹ 1ëŒ€
                        
                        document.getElementById("mapInfo").innerHTML = 
                            `${data.table.length}ê°œì˜ í† ì‚¬ ê³µê¸‰ì²˜ì™€ ê²½ë¡œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                             <strong style="color: #ffc107;">ğŸš› í•„ìš” ë¤í”„íŠ¸ëŸ­: ${dumpTruckCount}ëŒ€ (${demandVolume}mÂ³ ê¸°ì¤€)</strong>`;
                    }
                } else {
                    responseText = `ğŸ˜” ì¡°ê±´ì— ë§ëŠ” í† ì‚¬ ê³µê¸‰ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br>`;
                    if (data.suggestions) {
                        responseText += `<strong>ì œì•ˆ:</strong><br>`;
                        data.suggestions.forEach(suggestion => {
                            responseText += `â€¢ ${suggestion}<br>`;
                        });
                    }
                    clearMarkers();
                    document.getElementById("mapInfo").innerHTML = "ë§¤ì¹­ëœ í† ì‚¬ ê³µê¸‰ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.";
                }
            } else if (data.route && data.route.intent === 'SMALLTALK') {
                responseText = `ì•ˆë…•í•˜ì„¸ìš”! TOBARO í† ì„ ë§¤ì¹­ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ”ï¸<br>í† ì‚¬ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ì£¼ì‹œë©´ ë„ì›€ì„ ë“œë¦´ê²Œìš”!`;
            } else if (data.route && data.route.intent === 'LAW_QA') {
                responseText = `ğŸ“‹ <strong>ë²•ê·œ ë¬¸ì˜</strong><br><br>ì£„ì†¡í•©ë‹ˆë‹¤. ë²•ê·œ ê´€ë ¨ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.<br>í˜„ì¬ëŠ” í† ì‚¬ ë§¤ì¹­ ì„œë¹„ìŠ¤ë§Œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            } else if (data.followup) {
                responseText = data.followup;
                if (data.suggestions) {
                    responseText += `<br><br><strong>ë„ì›€ë§:</strong><br>`;
                    data.suggestions.forEach(suggestion => {
                        responseText += `â€¢ ${suggestion}<br>`;
                    });
                }
            } else {
                responseText = data.message || 'ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }

            addMessage(responseText, 'bot');
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ì…ë ¥ì°½ í¬ì»¤ìŠ¤
        messageInput.focus();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('SCRIPT READY: showRoutes is', typeof showRoutes);
            kakao.maps.load(function() {
                console.log('ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ');
                initMap();
            });
        });
    </script>
</body>
</html>
